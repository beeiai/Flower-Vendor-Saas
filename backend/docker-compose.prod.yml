# Production docker-compose.yml for deployment
version: '3.8'

services:
  backend:
    build: .
    ports:
      - "8000:8000"
    environment:
      # Database configuration - should be provided via environment or secrets
      - DATABASE_URL=${DATABASE_URL:-postgresql://postgres:password@db:5432/flower_vendor}
      - SECRET_KEY=${SECRET_KEY}
      - ALGORITHM=${ALGORITHM:-HS256}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES:-15}
      - REFRESH_TOKEN_EXPIRE_DAYS=${REFRESH_TOKEN_EXPIRE_DAYS:-7}
      - DB_POOL_SIZE=${DB_POOL_SIZE:-10}
      - DB_MAX_OVERFLOW=${DB_MAX_OVERFLOW:-20}
      - DB_POOL_TIMEOUT=${DB_POOL_TIMEOUT:-30}
      - DB_POOL_RECYCLE=${DB_POOL_RECYCLE:-3600}
      # Security settings
      - REQUIRE_SECURE_SECRETS=${REQUIRE_SECURE_SECRETS:-true}
      # Rate limiting
      - AUTH_RATE_LIMIT=${AUTH_RATE_LIMIT:-100}
      - AUTH_RATE_WINDOW_SECONDS=${AUTH_RATE_WINDOW_SECONDS:-60}
      - API_RATE_LIMIT=${API_RATE_LIMIT:-300}
      - API_RATE_WINDOW_SECONDS=${API_RATE_WINDOW_SECONDS:-60}
      # Redis for distributed rate limiting (optional)
      - REDIS_URL=${REDIS_URL}
      - ENABLE_DISTRIBUTED_RATE_LIMITING=${ENABLE_DISTRIBUTED_RATE_LIMITING:-false}
      # CORS - should be configured for production
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-http://localhost:5173,http://127.0.0.1:5173}
      # Gunicorn configuration
      - GUNICORN_WORKERS=${GUNICORN_WORKERS:-4}
      - GUNICORN_TIMEOUT=${GUNICORN_TIMEOUT:-30}
      - GUNICORN_MAX_REQUESTS=${GUNICORN_MAX_REQUESTS:-1000}
      - GUNICORN_MAX_REQUESTS_JITTER=${GUNICORN_MAX_REQUESTS_JITTER:-100}
    depends_on:
      - db
    restart: unless-stopped
    # Security: Don't mount source code in production
    # Health check to ensure service is ready
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-flower_vendor}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # Optional: mount init scripts
      # - ./init-scripts:/docker-entrypoint-initdb.d
    restart: unless-stopped
    # Security: Don't expose database port in production
    # ports: 
    #   - "5432:5432"  # Only uncomment for debugging

volumes:
  postgres_data: